#!/usr/bin/env bash

# exec &> >(tee /tmp/mods.log)

assert_installed gum mods
assert_defined ANTHROPIC_API_KEY

get_prompt() {
    user_prompt=$(gum write \
        --placeholder="Prompt ..." \
        --prompt="" \
        --no-show-help \
        --char-limit=0 \
        --cursor.foreground="#d79921")

    local exit_code=$?

    # I tried using wl-copy but that seems to leave a process in the background and
    # makes exiting from the script difficult
    if [[ $exit_code -eq 0 ]]; then
        clipwrite <<< "$user_prompt"
    fi

    return $exit_code
}

while [[ $# -gt 0 ]]; do
    case $1 in
    --continue)
        CONTINUE=true
        shift
        ;;
    *)
        echo "Unknown option: $1"
        exit 1
        ;;
    esac
done

if [[ -z $CONTINUE ]]; then
    get_prompt && \
        printf "ðŸ§‘ %s\nðŸ¤–\n" "$user_prompt" && \
        mods <<< "$user_prompt" || \
        exit
else
    mods --show-last
fi

while true; do
    get_prompt && \
    printf "ðŸ§‘ %s\nðŸ¤–\n" "$user_prompt" && \
    mods --continue-last <<< "$user_prompt" || \
    break
done
