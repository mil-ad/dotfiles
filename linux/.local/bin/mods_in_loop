#!/usr/bin/env bash

# exec &> >(tee /tmp/mods.log)

assert_installed gum mods
assert_defined ANTHROPIC_API_KEY

get_prompt() {
    user_prompt=$(gum write \
        --placeholder="Prompt ..." \
        --prompt="" \
        --no-show-help \
        --char-limit=0 \
        --cursor.foreground="#d79921")

    local exit_code=$?

    # I tried using wl-copy but that seems to leave a process in the background and
    # makes exiting from the script difficult
    if [[ $exit_code -eq 0 ]]; then
        clipwrite <<< "$user_prompt"
    fi

    return $exit_code
}

while [[ $# -gt 0 ]]; do
    case $1 in
    --continue)
        CONTINUE=true
        shift
        # Check if next argument is an ID (not empty and not starting with --)
        if [[ -n $1 && $1 != --* ]]; then
            CONTINUE_ID=$1
            shift
        fi
        ;;
    *)
        echo "Unknown option: $1"
        exit 1
        ;;
    esac
done

if [[ -z $CONTINUE ]]; then
    get_prompt && \
        printf "ðŸ§‘ %s\nðŸ¤–\n" "$user_prompt" && \
        mods <<< "$user_prompt" || \
        exit
else
    if [[ -n $CONTINUE_ID ]]; then
        mods --show "$CONTINUE_ID"
    else
        mods --show-last
    fi
fi

while true; do
    get_prompt || break
    printf "ðŸ§‘ %s\nðŸ¤–\n" "$user_prompt"
    if [[ -n $CONTINUE_ID ]]; then
        mods --continue "$CONTINUE_ID" <<< "$user_prompt" || break
    else
        mods --continue-last <<< "$user_prompt" || break
    fi
done
